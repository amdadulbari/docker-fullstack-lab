name: Dockerfile Lint

on:
  push:
    branches: [main]
    paths:
      - "**/Dockerfile"
      - ".github/workflows/hadolint.yml"
  pull_request:
    branches: [main]
    paths:
      - "**/Dockerfile"
      - ".github/workflows/hadolint.yml"

jobs:
  # ─────────────────────────────────────────────────────────────
  # Dynamically discover every Dockerfile in the repo so the
  # matrix stays up-to-date when new projects are added.
  # ─────────────────────────────────────────────────────────────
  discover:
    name: Discover Dockerfiles
    runs-on: ubuntu-latest
    outputs:
      dockerfiles: ${{ steps.find.outputs.files }}
    steps:
      - uses: actions/checkout@v4

      - name: Find all Dockerfiles
        id: find
        run: |
          files=$(find . -name "Dockerfile" -not -path "*/.git/*" \
            | sed 's|^\./||' \
            | sort \
            | jq -R -s -c 'split("\n")[:-1]')
          echo "files=$files" >> "$GITHUB_OUTPUT"
          echo "Found Dockerfiles:"
          echo "$files" | jq -r '.[]'

  # ─────────────────────────────────────────────────────────────
  # Run hadolint against every discovered Dockerfile in parallel.
  # fail-fast: false ensures all projects are checked even when
  # one fails, so you get a complete picture in a single run.
  # ─────────────────────────────────────────────────────────────
  hadolint:
    name: ${{ matrix.dockerfile }}
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        dockerfile: ${{ fromJson(needs.discover.outputs.dockerfiles) }}
    steps:
      - uses: actions/checkout@v4

      - name: Lint ${{ matrix.dockerfile }}
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ${{ matrix.dockerfile }}
          # Fail on error, warning, or info — nothing gets through
          failure-threshold: info
          # Ignored rules (project-wide):
          #   DL3008 — apt-get packages without pinned versions (acceptable for build stages)
          #   DL3018 — apk packages without pinned versions (same reason)
          ignore: DL3008,DL3018

  # ─────────────────────────────────────────────────────────────
  # Single required status check — gates merges on all matrix
  # jobs passing without having to list each one in branch rules.
  # ─────────────────────────────────────────────────────────────
  lint-complete:
    name: Hadolint passed
    needs: hadolint
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all jobs succeeded
        run: |
          if [[ "${{ needs.hadolint.result }}" != "success" ]]; then
            echo "One or more Dockerfile lint jobs failed."
            exit 1
          fi
          echo "All Dockerfiles passed hadolint."
