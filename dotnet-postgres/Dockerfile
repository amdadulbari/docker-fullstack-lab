# ════════════════════════════════════════════════════════════════
# Dockerfile — ASP.NET Core 8 + PostgreSQL
# Multi-stage build:
#   Stage 1 (builder)    → restores NuGet packages and publishes the app
#   Stage 2 (production) → copies only the published output, runs as non-root
#
# Multi-stage builds are important for .NET:
#   SDK image  (~800 MB) contains compilers, build tools, dotnet CLI
#   ASP.NET image (~220 MB) contains only the runtime — much smaller final image
# ════════════════════════════════════════════════════════════════


# ── Stage 1: Builder ─────────────────────────────────────────────
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS builder

WORKDIR /app

# Copy the project file first and restore NuGet packages.
# This layer is cached separately — Docker only re-runs restore when
# the .csproj changes, not on every source file change.
COPY *.csproj ./
RUN dotnet restore

# Copy the rest of the source and publish a Release build.
# --no-restore: packages were already restored in the previous step.
# -o /app/publish: output directory for the published artifacts.
COPY . ./
RUN dotnet publish -c Release -o /app/publish --no-restore


# ── Stage 2: Production ───────────────────────────────────────────
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS production

WORKDIR /app

# Copy only the published output from the builder stage.
# No SDK, no source code, no build tools in the final image.
COPY --from=builder /app/publish .

# ── Non-root User ─────────────────────────────────────────────────
# Running as root inside a container is a security risk.
# Create a dedicated app user with no home directory and no login shell.
RUN addgroup --system appgroup && \
    adduser  --system --ingroup appgroup --no-create-home appuser

RUN chown -R appuser:appgroup /app
USER appuser

# ASP.NET Core 8 defaults to port 8080 inside the container.
# Set explicitly to be clear and to match the docker-compose port mapping.
EXPOSE 8080
ENV ASPNETCORE_HTTP_PORTS=8080

# dotnet-postgres.dll is the entry point generated by 'dotnet publish'.
ENTRYPOINT ["dotnet", "dotnet-postgres.dll"]
